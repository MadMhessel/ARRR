:root{
  --sidebar-width:280px;
  --bg:#f8f9fa;
  --paper:#ffffff;
  --border:#dee2e6;
  --text:#212529;
  --muted:#6c757d;
  --danger:#dc3545;
  --ui-accent:#0066cc;
  --wall-stroke:2px;
  --furn-stroke:1.4px;
  --furn-detail-stroke:0.75px;
  --outline:#161a17;
  --accent:#4e6b57;
  --fill-light:rgba(118,168,132,0.18);
  --stroke:var(--furn-stroke);
  --handle:var(--ui-accent);
  --select:rgba(0,102,204,0.85);
  --radius:12px;
  --padding:10px;
}

svg.plan *{vector-effect:non-scaling-stroke;}
.shape{vector-effect:non-scaling-stroke;stroke:var(--outline);stroke-width:var(--furn-stroke);fill:none;stroke-linejoin:round;stroke-linecap:round;}
.shape-fill{fill:var(--fill-light);stroke:var(--outline);stroke-width:var(--furn-stroke);}
.shape-detail{vector-effect:non-scaling-stroke;stroke:var(--outline);stroke-width:var(--furn-detail-stroke);fill:none;stroke-linejoin:round;stroke-linecap:round;}
.furn-center{stroke:var(--accent);stroke-width:var(--furn-detail-stroke);stroke-dasharray:3 2;fill:none;vector-effect:non-scaling-stroke;}
.svg-mode--schematic .rich-only{display:none!important;}
.svg-mode--schematic .schematic-only{display:inline!important;}
.svg-mode--rich .schematic-only{display:none!important;}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
.app{display:flex;height:100%}

/* --- Left Sidebar --- */
#sidebar{width:var(--sidebar-width);background:var(--paper);border-right:1px solid var(--border);padding:18px;display:flex;flex-direction:column;gap:10px;overflow:auto;box-shadow:0 0 15px rgba(0,0,0,.05)}
#sidebar h2{font-size:18px;margin:0 0 10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
#sidebar h3{font-size:12px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin:10px 0 6px}
.draggable-item, .tool-button {display:flex;align-items:center;gap:8px;line-height:1;padding:9px 10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:#fafafa;cursor:pointer;user-select:none;transition:.2s}
.draggable-item:hover, .tool-button:hover {background:#e9ecef;box-shadow:0 2px 4px rgba(0,0,0,.08);transform:translateY(-1px)}
.tool-button.active { background-color: var(--ui-accent); color: white; border-color: var(--ui-accent); }
#btnExport, #btnAnalysis, #btnCsv, #btnTemplate, #btnFocus, #btn-focus, .ui-bar button[data-icon] {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  line-height: 1;
}

.ui-bar button[data-icon].icon-only {
  padding: 6px;
  gap: 0;
  justify-content: center;
}

/* Иконки в кнопках панелей */
.tool-button .icon, .ui-bar button[data-icon] .icon, #btnFocus .icon, #btn-focus .icon {
  width: 18px;
  height: 18px;
  display: inline-flex;
}

.ui-bar button[data-icon].icon-only .icon {
  width: 20px;
  height: 20px;
}

.tool-button .icon svg, .ui-bar button[data-icon] .icon svg, #btnFocus .icon svg, #btn-focus .icon svg {
  width: 18px;
  height: 18px;
  fill: currentColor;
  stroke: currentColor;
  opacity: 0.92;
}

.ui-bar button[data-icon].icon-only .icon svg {
  width: 20px;
  height: 20px;
}

.tool-button.active .icon svg {
  opacity: 1;
}

.tool-button .label, .ui-bar button[data-icon] .label, #btnFocus .label, #btn-focus .label {
  white-space: nowrap;
}
#trash{margin-top:auto;padding:14px;border:2px dashed var(--border);border-radius:8px;text-align:center;color:var(--muted);transition:.3s}
#trash.drag-enter{background:rgba(220,53,69,.08);border-color:var(--danger);color:var(--danger)}

/* --- Main Content --- */
#main{flex:1;display:flex;justify-content:center;align-items:center;padding:12px;overflow:hidden;position:relative;background:#fff;}
#wrap{
  position:relative;
  width:100%;
  height:100%;
  max-width:1000px;
  max-height:1000px;
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:0 8px 30px rgba(0,0,0,.12);
  overflow:hidden;
}
svg{width:100%;height:100%}
svg.tool-active { cursor: crosshair; }
.wall,.inner-wall,.win,.col,.door-arc,.dim-line {vector-effect:non-scaling-stroke}
#walls-layer .wall {
  cursor: pointer;
}
#walls-layer .wall .wall-body,
#walls-layer .wall .wall-edge {
  fill: none;
  transition: stroke .2s ease, stroke-width .2s ease, stroke-dasharray .2s ease;
}
#walls-layer .wall .wall-body {
  stroke-linecap: butt;
  stroke-linejoin: round;
}
#walls-layer .wall .wall-edge {
  stroke-linecap: butt;
  stroke-linejoin: round;
  pointer-events: stroke;
}
#walls-layer .wall.selected .wall-edge {
  filter: drop-shadow(0 0 6px rgba(0,102,204,.6));
}
#walls-layer .wall.selected .wall-body {
  filter: drop-shadow(0 0 4px rgba(0,102,204,.35));
}
.wall-component { cursor: pointer; }
.wall-component.selected > * { stroke: var(--ui-accent) !important; stroke-width: 3; vector-effect: non-scaling-stroke; }
.floor{fill:#fdfdfd;}
#grid-layer{pointer-events:none}

#preview-layer,
#analysis-layer,
#measurement-layer,
#ui-layer{pointer-events:none}

/* --- Measurement Layer --- */
#measurement-layer line {
  vector-effect: non-scaling-stroke;
  stroke: var(--accent);
  /* Толще, чтобы линия была лучше видна */
  stroke-width: 3;
  marker-start: url(#dim-arrow);
  marker-end: url(#dim-arrow);
}
#measurement-layer text {
  font-size: 14px;
  font-weight: bold;
  fill: var(--accent);
  stroke: white;
  stroke-width: 0.5;
  paint-order: stroke;
  pointer-events: none;
}

/* Слой измерений не должен перехватывать события мыши, иначе клики перестанут работать */
#measurement-layer {
  pointer-events: none;
}

#snap-markers {
  pointer-events: none;
}

#snap-markers circle {
  fill: var(--accent);
  opacity: 0.25;
  stroke: none;
  vector-effect: non-scaling-stroke;
}

#snap-markers circle[data-primary="true"] {
  opacity: 0.45;
}

/* --- Collision highlighting (для анализа коллизий) --- */
.layout-object.collision .shape {
  stroke: var(--danger) !important;
  stroke-width: 3 !important;
}
.wall-component.collision > * {
  stroke: var(--danger) !important;
  stroke-width: 3 !important;
}

/* --- Layout Objects --- */
.layout-object{cursor:move;}
.layout-object .core{
  transition:opacity .2s ease;
}
.layout-object:hover .core{opacity:0.94;}
.layout-object.selected .core{opacity:0.9;}
#items-layer .layout-object .core path,
#items-layer .layout-object .core rect,
#items-layer .layout-object .core circle,
#items-layer .layout-object .core ellipse,
#items-layer .layout-object .core polygon,
#items-layer .layout-object .core polyline {
  vector-effect:non-scaling-stroke;
  stroke-linejoin:round;
  stroke-linecap:round;
}
#items-layer .layout-object .core .shape {
  paint-order:stroke fill;
  stroke-width:var(--furn-stroke);
  stroke:var(--outline);
  stroke-opacity:1;
}
.layout-object.selected .selection-box{display:block}
.selection-box{
  display:none;
  fill:none;
  stroke:var(--select);
  stroke-width:4;
  stroke-dasharray:10 5;
  pointer-events:none;
  vector-effect:non-scaling-stroke;
}
.resize-handle,
.rotate-handle{
  display:none;
  fill:var(--handle);
  stroke:#fff;
  stroke-width:2;
}
.layout-object.selected .resize-handle,.layout-object.selected .rotate-handle{display:block}
.resize-handle{
  cursor:nwse-resize;
  width:16px;
  height:16px;
  pointer-events:auto;
}
.rotate-handle{
  cursor:grab;
  r:10;
  pointer-events:auto;
}

/* --- UI Elements --- */
.ui-bar{
  position:absolute;
  z-index:1001;
  background:var(--paper);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  padding:8px 12px;
  display:flex;
  gap:12px;
  align-items:center;
  font-size:13px;
}
.ui-bar button{
  border:1px solid var(--border);
  background:var(--paper);
  border-radius:var(--radius);
  padding:6px 10px;
  cursor:pointer;
  transition:background .15s;
}
.ui-bar button:hover{
  background:#f6f7f8;
}
#grid-controls-bar{right:12px;top:12px;}
#grid-controls-bar label{display:flex;gap:6px;align-items:center}
#grid-controls-bar .grid-step-control{gap:8px;white-space:nowrap}
#grid-controls-bar input[type="number"]{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;width:88px;font-size:14px;line-height:1.3;}
#grid-controls-bar input[type="number"]::-webkit-outer-spin-button,
#grid-controls-bar input[type="number"]::-webkit-inner-spin-button{margin:0}
#grid-controls-bar input[type="number"]{-moz-appearance:textfield}
#grid-controls-bar .grid-step-unit{font-size:12px;color:var(--muted);}
#toast{position:absolute;left:50%;top:20px;transform:translateX(-50%);background:#212529;color:#fff;padding:10px 16px;border-radius:8px;font-size:13px;opacity:0;transition:.2s;pointer-events:none;z-index:9999;}
#toast.show{opacity:0.95}

/* --- Context Menu --- */
#ctx{position:absolute;display:none;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:8px 0;z-index:1002;min-width:220px;border:1px solid var(--border)}
#ctx button{display:block;width:100%;padding:10px 16px;border:0;background:none;text-align:left;font-size:14px;cursor:pointer}
#ctx button:hover{background:#f1f3f5}
#ctx hr{border:none;border-top:1px solid var(--border);margin:6px 0}
#ctx .kbd{float:right;color:var(--muted)}
#ctx .danger{color:var(--danger)}

/* --- Right Properties Panel --- */
#properties{width:var(--sidebar-width);background:var(--paper);border-left:1px solid var(--border);padding:18px;display:flex;flex-direction:column;gap:10px;overflow:auto;box-shadow:0 0 15px rgba(0,0,0,.05)}
#properties h2{font-size:18px;margin:0 0 10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
#prop-placeholder{color:var(--muted);font-size:14px;text-align:center;margin-top:20px}
#prop-controls.hidden{display:none}
#prop-controls{display:grid;grid-template-columns:auto 1fr;gap:12px 8px;align-items:center}
#prop-controls label{font-size:14px;white-space:nowrap}
#prop-controls input{width:100%;border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:14px}
#prop-controls .prop-label {justify-self: end;}

#properties{gap:14px;}

#wall-properties .panel-header h3{letter-spacing:.12em;}
.wall-type-caption{
  margin:0 0 6px;
  font-size:11px;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--muted);
}
.wall-type-options{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
}
.wall-type-option{
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 12px;
  background:#fff;
  cursor:pointer;
  transition:border .2s ease, box-shadow .2s ease, background .2s ease;
  font-size:13px;
  color:var(--text);
}
.wall-type-option svg{width:48px;height:18px;overflow:visible;}
.wall-type-option line{stroke-linecap:butt;stroke-linejoin:round;}
.wall-type-option[data-type="structural"] line{stroke:#0F2E2B;stroke-width:12;stroke-opacity:.85;}
.wall-type-option[data-type="partition"] line{stroke:#0F2E2B;stroke-width:9;stroke-dasharray:18 8;stroke-opacity:.7;}
.wall-type-option[data-type="glass"] line{stroke:#2F7EBB;stroke-width:7;stroke-dasharray:12 6;}
.wall-type-option[data-type="half"] line{stroke:#0F2E2B;stroke-width:7;stroke-dasharray:8 6;stroke-opacity:.55;}
.wall-type-option.active{
  border-color:var(--ui-accent);
  box-shadow:0 0 0 2px rgba(0,102,204,.2);
  background:rgba(0,102,204,.06);
  color:var(--ui-accent);
}
.wall-type-option:focus-visible{outline:2px solid var(--ui-accent);}

.wall-length-label{
  font-size:18px;
  font-weight:600;
  fill:var(--text);
  stroke:rgba(255,255,255,.92);
  stroke-width:5;
  paint-order:stroke fill;
  pointer-events:none;
}

.panel{border:1px solid var(--border);border-radius:10px;padding:12px;background:var(--paper);display:flex;flex-direction:column;gap:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}
.panel-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.panel-header h3{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
.panel-actions{display:flex;gap:6px}
.panel-actions button,.panel-actions select{border:1px solid var(--border);background:#fff;border-radius:8px;padding:4px 8px;font-size:13px;cursor:pointer}
.component-fieldset{border:1px solid var(--border);border-radius:8px;padding:8px;display:flex;flex-direction:column;gap:6px;margin:0}
.component-fieldset legend{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
.component-fieldset label{display:flex;align-items:center;gap:6px;font-size:13px;}
.component-fieldset input[type="radio"]{accent-color:var(--ui-accent);}
.component-fieldset.hidden{display:none;}
.panel-row{display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:13px;color:var(--text)}
.panel-row input,.panel-row select{flex:1;border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:13px}

#measure-table,#analysis-rooms-table{width:100%;border-collapse:collapse;font-size:12px}
#measure-table thead th,#analysis-rooms-table thead th{text-align:left;font-weight:600;color:var(--muted);padding-bottom:6px;border-bottom:1px solid var(--border)}
#measure-table tbody td,#analysis-rooms-table tbody td{padding:4px 0;border-bottom:1px dashed rgba(0,0,0,.05)}
#measure-table tbody tr:last-child td,#analysis-rooms-table tbody tr:last-child td{border-bottom:none}
#measure-table button{border:none;background:none;cursor:pointer;color:var(--danger)}

#analysis-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:12px}
#analysis-summary .summary-card{background:rgba(0,102,204,.05);border:1px solid rgba(0,102,204,.15);border-radius:8px;padding:8px}
#analysis-summary .summary-card h4{margin:0 0 4px;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase}
#analysis-summary .summary-card span{font-size:16px;font-weight:600;color:var(--text)}

.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

.wall-handles{pointer-events:none}
.wall-handles circle{fill:var(--ui-accent);stroke:#fff;stroke-width:2;pointer-events:all;cursor:pointer}
.wall-handles circle.active{fill:var(--danger)}
.wall-segment-insert{fill:#fff;stroke:var(--ui-accent);stroke-dasharray:2 2;pointer-events:all;cursor:crosshair;opacity:.7}
#walls-layer .wall.selected .wall-handles,#walls-layer .wall.selected .wall-segment-insert{display:block}
#walls-layer .wall .wall-handles,#walls-layer .wall .wall-segment-insert{display:none}
.status-ok{color:#2b8a3e;font-weight:600}
.status-warn{color:var(--danger);font-weight:600}


/* --- Layers Panel --- */
#layers-panel{margin-top:20px;border-top:1px solid var(--border);padding-top:10px}
#layers-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px}
#layers-list li{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;cursor:pointer;transition:.15s;font-size:13px}
#layers-list li:hover{background:#f1f3f5}
#layers-list li.selected{background:var(--ui-accent);color:#fff}
#layers-list .layer-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#layers-list .layer-vis,#layers-list .layer-lock{border:none;background:none;cursor:pointer;padding:2px 4px;opacity:.6}
#layers-list li.selected .layer-vis,#layers-list li.selected .layer-lock{opacity:1}
#layers-list .layer-vis:hover,#layers-list .layer-lock:hover{opacity:1}
#layers-list .locked .layer-name{text-decoration:line-through;opacity:.7}

/* --- Mobile / Responsive --- */
#mobile-toggles {
    display: none;
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1002;
    gap: 8px;
}
#mobile-toggles button {
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
    display: flex;
    align-items: center;
    justify-content: center;
}
#toggle-properties {
    position: fixed;
    right: 10px;
    left: auto;
}

/* Курсор при панорамировании */
body.panning, svg.panning {
  cursor: grabbing !important;
}

@media (max-width: 1024px) {
    #sidebar, #properties {
        position: fixed;
        top: 0;
        height: 100%;
        z-index: 2000;
        transform: translateX(-105%);
        transition: transform 0.3s ease-in-out;
        box-shadow: 0 0 20px rgba(0,0,0,.2);
        width: 300px;
    }
    #properties {
        right: 0;
        left: auto;
        transform: translateX(105%);
    }
    #sidebar.visible, #properties.visible {
        transform: translateX(0);
    }
    #mobile-toggles {
        display: flex;
    }
    #main {
        padding: 0;
    }
    #wrap {
        border-radius: 0;
        border: none;
        box-shadow: none;
        height: 100%;
        max-height: none;
    }
}




/* Safe appended overrides to ensure toolbar receives pointer events and sits above canvas */
.toolbar { z-index: 9999 !important; pointer-events: auto !important; }
.toolbar .tool-button, .toolbar button { pointer-events: auto !important; }
#sidebar { z-index: 9998 !important; pointer-events: auto !important; }



/* FIX: гарантируем, что боковая панель и кнопки инструментов находятся над рабочей областью
   и получают pointer-events (неперекрываемые). */
#sidebar {
  position: relative !important;
  z-index: 10010 !important;
  pointer-events: auto !important;
}
.tool-button, #tool-pointer, #tool-wall, #tool-door, #tool-window {
  position: relative !important;
  z-index: 10011 !important;
  pointer-events: auto !important;
  user-select: none;
}
